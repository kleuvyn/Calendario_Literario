{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/kleuvyn/Documentos/MeusRepositorios/Calendario_Literario/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL || process.env.POSTGRES_URL,\n  ssl: {\n    rejectUnauthorized: false \n  }\n});\n\nexport async function executeQuery(query: string, params: any[] = []) {\n  try {\n\n    await pool.query('ALTER TABLE users ADD COLUMN IF NOT EXISTS password TEXT;');\n    await pool.query('ALTER TABLE users ADD COLUMN IF NOT EXISTS image TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS author TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS rating INTEGER;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS cover_url TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS email TEXT;');\n\n    const result = await pool.query(query, params);\n    return result.rows; \n  } catch (error) {\n    console.error('Erro detalhado no Banco de Dados:', error);\n    throw error;\n  }\n}"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,YAAY;IACtE,KAAK;QACH,oBAAoB;IACtB;AACF;AAEO,eAAe,aAAa,KAAa,EAAE,SAAgB,EAAE;IAClE,IAAI;QAEF,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QAEjB,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC,OAAO;QACvC,OAAO,OAAO,IAAI;IACpB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM;IACR;AACF"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///home/kleuvyn/Documentos/MeusRepositorios/Calendario_Literario/app/api/reading-data/route.ts"],"sourcesContent":["import { executeQuery } from \"@/lib/db\";\nimport { NextResponse } from \"next/server\";\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const email = searchParams.get(\"email\");\n  const year = Number(searchParams.get(\"year\"));\n\n  if (!email || !year) return NextResponse.json({ data: [], userGoal: 12 });\n\n  try {\n    const query = `\n      SELECT rd.*, \n             br.rating, \n             br.cover_url,\n             br.genre,\n             br.review,\n             COALESCE(br.total_pages, rd.total_pages, 0) as total_pages\n      FROM public.reading_data rd\n      LEFT JOIN public.users u ON u.email = rd.email\n      LEFT JOIN public.book_reviews br ON (u.id = br.user_id AND rd.book_name = br.title)\n      WHERE rd.email = $1 AND rd.year = $2\n      ORDER BY rd.month ASC, rd.status DESC\n    `;\n    \n    const rows = await executeQuery(query, [email, year]);\n    \n    const userRow = await executeQuery(`SELECT literary_goal FROM public.users WHERE email = $1`, [email]);\n    const userGoal = userRow && userRow.length > 0 ? (userRow[0].literary_goal || 12) : 12;\n\n    const cleanRows = rows.map((b: any) => ({\n      ...b,\n      rating: Number(b.rating) || 0,\n      total_pages: Number(b.total_pages) || 0,\n      month: Number(b.month),\n      status: b.status || 'lendo' \n    }));\n\n    return NextResponse.json({ data: cleanRows, userGoal });\n  } catch (error: any) {\n    console.error(\"Erro na API GET:\", error);\n    return NextResponse.json({ data: [], userGoal: 12 });\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { \n      email, bookName, oldBookName, action, rating, coverUrl, \n      totalPages, review, genre, year, month, \n      startDate, endDate, goal \n    } = body;\n    \n    if (action === \"SET_GOAL\") {\n      await executeQuery(`\n        INSERT INTO public.users (email, literary_goal)\n        VALUES ($1, $2)\n        ON CONFLICT (email) \n        DO UPDATE SET literary_goal = EXCLUDED.literary_goal\n      `, [email, Number(goal)]);\n      return NextResponse.json({ success: true });\n    }\n\n    const pages = Number(totalPages) || 0;\n\n    if (action === \"EDIT_READING\") {\n      await executeQuery(\n        `UPDATE public.reading_data SET book_name = $1 \n         WHERE email = $2 AND book_name = $3`,\n        [bookName, email, oldBookName]\n      );\n      \n      const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n      if (userRes.length > 0) {\n        await executeQuery(\n          `UPDATE public.book_reviews SET title = $1 \n           WHERE user_id = $2 AND title = $3`,\n          [bookName, userRes[0].id, oldBookName]\n        );\n      }\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"DELETE_READING\") {\n      await executeQuery(\n        `DELETE FROM public.reading_data WHERE email = $1 AND book_name = $2`,\n        [email, bookName]\n      );\n      const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n      if (userRes.length > 0) {\n        await executeQuery(\n          `DELETE FROM public.book_reviews WHERE user_id = $1 AND title = $2`,\n          [userRes[0].id, bookName]\n        );\n      }\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"START_READING\") {\n      await executeQuery(`\n        INSERT INTO public.reading_data (email, book_name, start_date, status, year, month)\n        VALUES ($1, $2, $3, 'lendo', $4, $5)\n        ON CONFLICT DO NOTHING\n      `, [email, bookName, startDate, year, month]);\n      return NextResponse.json({ success: true });\n    }\n\n    // --- CORREÇÃO AQUI: FINISH_READING ---\n    if (action === \"FINISH_READING\") {\n      // Removemos a trava 'AND status = lendo' para garantir que o clique no calendário \n      // sempre consiga sobrescrever ou definir a data final.\n      await executeQuery(\n        `UPDATE public.reading_data \n         SET end_date = $1, status = 'lido' \n         WHERE email = $2 AND book_name = $3`,\n        [endDate, email, bookName]\n      );\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"UPDATE_REVIEW\") {\n      const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n      if (userRes.length === 0) return NextResponse.json({ error: \"Usuário não encontrado\" });\n      const userId = userRes[0].id;\n\n      const targetName = oldBookName || bookName;\n\n      await executeQuery(\n        `UPDATE public.reading_data \n         SET book_name = $1, total_pages = $2 \n         WHERE email = $3 AND book_name = $4`,\n        [bookName, pages, email, targetName]\n      );\n\n      if (oldBookName && oldBookName !== bookName) {\n        await executeQuery(\n          `UPDATE public.book_reviews \n           SET title = $1 \n           WHERE user_id = $2 AND title = $3`,\n          [bookName, userId, oldBookName]\n        );\n      }\n\n      await executeQuery(`\n        INSERT INTO public.book_reviews (user_id, title, rating, cover_url, total_pages, genre, review, year, month)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n        ON CONFLICT (user_id, title) DO UPDATE SET \n          rating = EXCLUDED.rating, \n          cover_url = EXCLUDED.cover_url, \n          total_pages = EXCLUDED.total_pages,\n          genre = EXCLUDED.genre,\n          review = EXCLUDED.review\n      `, [userId, bookName, rating, coverUrl, pages, genre, review, year, month]);\n\n      return NextResponse.json({ success: true });\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Erro no POST:\", error.message);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}