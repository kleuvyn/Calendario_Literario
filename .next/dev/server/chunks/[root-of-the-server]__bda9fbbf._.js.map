{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/kleuvyn/Documentos/MeusRepositorios/Calendario_Literario/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL || process.env.POSTGRES_URL,\n  ssl: {\n    rejectUnauthorized: false \n  }\n});\n\nexport async function executeQuery(query: string, params: any[] = []) {\n  try {\n\n    await pool.query('ALTER TABLE users ADD COLUMN IF NOT EXISTS password TEXT;');\n    await pool.query('ALTER TABLE users ADD COLUMN IF NOT EXISTS image TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS author TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS rating INTEGER;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS cover_url TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS email TEXT;');\n\n    const result = await pool.query(query, params);\n    return result.rows; \n  } catch (error) {\n    console.error('Erro detalhado no Banco de Dados:', error);\n    throw error;\n  }\n}"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,YAAY;IACtE,KAAK;QACH,oBAAoB;IACtB;AACF;AAEO,eAAe,aAAa,KAAa,EAAE,SAAgB,EAAE;IAClE,IAAI;QAEF,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QAEjB,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC,OAAO;QACvC,OAAO,OAAO,IAAI;IACpB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM;IACR;AACF"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///home/kleuvyn/Documentos/MeusRepositorios/Calendario_Literario/app/api/reading-data/route.ts"],"sourcesContent":["import { executeQuery } from \"@/lib/db\";\nimport { NextResponse } from \"next/server\";\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const email = searchParams.get(\"email\");\n  const year = Number(searchParams.get(\"year\"));\n  // Detecta se é a página de retrospectiva\n  const isRetrospective = searchParams.get(\"isRetrospective\") === \"true\";\n\n  if (!email || !year) return NextResponse.json({ data: [], userGoal: 12 });\n\n  try {\n    // Query adaptada: na retrospectiva traz só o ano, na home traz o ano + o que está \"lendo\"\n    const query = isRetrospective \n      ? `\n      SELECT rd.*, br.rating, br.cover_url, br.genre, br.review,\n             COALESCE(br.total_pages, rd.total_pages, 0) as total_pages\n      FROM public.reading_data rd\n      LEFT JOIN public.users u ON u.email = rd.email\n      LEFT JOIN public.book_reviews br ON (u.id = br.user_id AND rd.book_name = br.title)\n      WHERE rd.email = $1 AND rd.year = $2\n      ORDER BY rd.month ASC, rd.status DESC\n    `\n      : `\n      SELECT rd.*, br.rating, br.cover_url, br.genre, br.review,\n             COALESCE(br.total_pages, rd.total_pages, 0) as total_pages\n      FROM public.reading_data rd\n      LEFT JOIN public.users u ON u.email = rd.email\n      LEFT JOIN public.book_reviews br ON (u.id = br.user_id AND rd.book_name = br.title)\n      WHERE rd.email = $1 AND (rd.year = $2 OR rd.status = 'lendo')\n      ORDER BY rd.month ASC, rd.status DESC\n    `;\n    \n    const rows = await executeQuery(query, [email, year]);\n    \n    // BUSCA META POR ANO NO CAMPO goals_by_year\n    const userRow = await executeQuery(`SELECT literary_goal, goals_by_year FROM public.users WHERE email = $1`, [email]);\n    let userGoal = 12;\n\n    if (userRow && userRow.length > 0) {\n      const goalsJson = userRow[0].goals_by_year;\n      const globalGoal = userRow[0].literary_goal || 12;\n      \n      if (goalsJson) {\n        const goals = typeof goalsJson === 'string' ? JSON.parse(goalsJson) : goalsJson;\n        userGoal = goals[year.toString()] || globalGoal;\n      } else {\n        userGoal = globalGoal;\n      }\n    }\n\n    const cleanRows = rows.map((b: any) => ({\n      ...b,\n      rating: Number(b.rating) || 0,\n      total_pages: Number(b.total_pages) || 0,\n      month: Number(b.month),\n      status: b.status || 'lendo' \n    }));\n\n    return NextResponse.json({ data: cleanRows, userGoal });\n  } catch (error: any) {\n    console.error(\"Erro na API GET:\", error);\n    return NextResponse.json({ data: [], userGoal: 12 });\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { \n      email, bookName, oldBookName, action, rating, coverUrl, \n      totalPages, review, genre, year, month, \n      startDate, endDate, goal \n    } = body;\n    \n    // --- SALVAR META POR ANO (CORRIGIDO) ---\n    if (action === \"SET_GOAL\") {\n      // Garante que a coluna existe\n      await executeQuery(`ALTER TABLE public.users ADD COLUMN IF NOT EXISTS goals_by_year JSONB DEFAULT '{}'::jsonb`, []);\n      \n      const userRes = await executeQuery(`SELECT goals_by_year FROM public.users WHERE email = $1`, [email]);\n      let currentGoals = {};\n      \n      if (userRes.length > 0 && userRes[0].goals_by_year) {\n        currentGoals = typeof userRes[0].goals_by_year === 'string' \n          ? JSON.parse(userRes[0].goals_by_year) \n          : userRes[0].goals_by_year;\n      }\n\n      const updatedGoals = { ...currentGoals, [year.toString()]: Number(goal) };\n\n      await executeQuery(\n        `UPDATE public.users SET goals_by_year = $1 WHERE email = $2`,\n        [JSON.stringify(updatedGoals), email]\n      );\n      return NextResponse.json({ success: true });\n    }\n\n    const pages = Number(totalPages) || 0;\n\n    if (action === \"EDIT_READING\") {\n      await executeQuery(\n        `UPDATE public.reading_data SET book_name = $1 WHERE email = $2 AND book_name = $3`,\n        [bookName, email, oldBookName]\n      );\n      const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n      if (userRes.length > 0) {\n        await executeQuery(\n          `UPDATE public.book_reviews SET title = $1 WHERE user_id = $2 AND title = $3`,\n          [bookName, userRes[0].id, oldBookName]\n        );\n      }\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"DELETE_READING\") {\n      await executeQuery(`DELETE FROM public.reading_data WHERE email = $1 AND book_name = $2`, [email, bookName]);\n      const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n      if (userRes.length > 0) {\n        await executeQuery(`DELETE FROM public.book_reviews WHERE user_id = $1 AND title = $2`, [userRes[0].id, bookName]);\n      }\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"START_READING\") {\n      // Usando DELETE + INSERT para evitar erro de ON CONFLICT sem constraint\n      await executeQuery(`DELETE FROM public.reading_data WHERE email = $1 AND book_name = $2`, [email, bookName]);\n      await executeQuery(`\n        INSERT INTO public.reading_data (email, book_name, start_date, status, year, month, cover_url, total_pages)\n        VALUES ($1, $2, $3, 'lendo', $4, $5, $6, $7)\n      `, [email, bookName, startDate, year, month, coverUrl, pages]);\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"FINISH_READING\") {\n      await executeQuery(\n        `UPDATE public.reading_data SET end_date = $1, status = 'lido' WHERE email = $2 AND book_name = $3`,\n        [endDate, email, bookName]\n      );\n      return NextResponse.json({ success: true });\n    }\n\n    if (action === \"UPDATE_REVIEW\") {\n      const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n      if (userRes.length === 0) return NextResponse.json({ error: \"Usuário não encontrado\" });\n      const userId = userRes[0].id;\n      const targetName = oldBookName || bookName;\n\n      await executeQuery(\n        `UPDATE public.reading_data SET book_name = $1, total_pages = $2, cover_url = $3 \n         WHERE email = $4 AND book_name = $5`,\n        [bookName, pages, coverUrl, email, targetName]\n      );\n\n      // Atualiza ou Insere a Review\n      await executeQuery(`DELETE FROM public.book_reviews WHERE user_id = $1 AND title = $2`, [userId, bookName]);\n      await executeQuery(`\n        INSERT INTO public.book_reviews (user_id, title, rating, cover_url, total_pages, genre, review, year, month)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n      `, [userId, bookName, rating, coverUrl, pages, genre, review, year, month]);\n\n      return NextResponse.json({ success: true });\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Erro no POST:\", error.message);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}