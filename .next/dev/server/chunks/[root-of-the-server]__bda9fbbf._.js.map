{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/kleuvyn/Documentos/MeusRepositorios/Calendario_Literario/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL || process.env.POSTGRES_URL,\n  ssl: {\n    rejectUnauthorized: false \n  }\n});\n\nexport async function executeQuery(query: string, params: any[] = []) {\n  try {\n\n    await pool.query('ALTER TABLE users ADD COLUMN IF NOT EXISTS password TEXT;');\n    await pool.query('ALTER TABLE users ADD COLUMN IF NOT EXISTS image TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS author TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS rating INTEGER;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS cover_url TEXT;');\n    await pool.query('ALTER TABLE reading_data ADD COLUMN IF NOT EXISTS email TEXT;');\n\n    const result = await pool.query(query, params);\n    return result.rows; \n  } catch (error) {\n    console.error('Erro detalhado no Banco de Dados:', error);\n    throw error;\n  }\n}"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,YAAY;IACtE,KAAK;QACH,oBAAoB;IACtB;AACF;AAEO,eAAe,aAAa,KAAa,EAAE,SAAgB,EAAE;IAClE,IAAI;QAEF,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QACjB,MAAM,KAAK,KAAK,CAAC;QAEjB,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC,OAAO;QACvC,OAAO,OAAO,IAAI;IACpB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM;IACR;AACF"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///home/kleuvyn/Documentos/MeusRepositorios/Calendario_Literario/app/api/reading-data/route.ts"],"sourcesContent":["import { executeQuery } from \"@/lib/db\";\nimport { NextResponse } from \"next/server\";\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const email = searchParams.get(\"email\");\n  const year = Number(searchParams.get(\"year\"));\n\n  if (!email || !year) return NextResponse.json({ data: [] });\n\n  try {\n    const query = `\n      SELECT rd.*, \n             br.rating, \n             br.cover_url,\n             br.genre,\n             br.review,\n             -- O nome precisa ser total_pages para o cálculo de stats\n             COALESCE(br.total_pages, rd.total_pages, 0) as total_pages\n      FROM public.reading_data rd\n      LEFT JOIN public.users u ON u.email = rd.email\n      LEFT JOIN public.book_reviews br ON (u.id = br.user_id AND rd.book_name = br.title)\n      WHERE rd.email = $1 AND rd.year = $2\n      ORDER BY rd.month ASC, rd.status DESC\n    `;\n    \n    const rows = await executeQuery(query, [email, year]);\n\n    // Garantimos que os campos críticos sejam números para os cálculos de stats\n    const cleanRows = rows.map((b: any) => ({\n      ...b,\n      rating: Number(b.rating) || 0,\n      total_pages: Number(b.total_pages) || 0,\n      month: Number(b.month)\n    }));\n\n    return NextResponse.json({ data: cleanRows });\n  } catch (error: any) {\n    console.error(\"Erro na API:\", error);\n    return NextResponse.json({ data: [] });\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { email, bookName, action, rating, coverUrl, totalPages, review, genre, year, month } = body;\n    const pages = Number(totalPages) || 0;\n\n    const userRes = await executeQuery(`SELECT id FROM public.users WHERE email = $1`, [email]);\n    if (userRes.length === 0) return NextResponse.json({ error: \"Usuário não encontrado\" });\n    const userId = userRes[0].id;\n\n    if (action === \"UPDATE_REVIEW\") {\n      await executeQuery(`\n        INSERT INTO public.book_reviews (user_id, title, rating, cover_url, total_pages, genre, review, year, month)\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n        ON CONFLICT (user_id, title) DO UPDATE SET \n          rating = EXCLUDED.rating, \n          cover_url = EXCLUDED.cover_url, \n          total_pages = EXCLUDED.total_pages,\n          genre = EXCLUDED.genre,\n          review = EXCLUDED.review\n      `, [userId, bookName, rating, coverUrl, pages, genre, review, year, month]);\n\n      await executeQuery(\n        `UPDATE public.reading_data SET total_pages = $1 WHERE email = $2 AND book_name = $3`,\n        [pages, email, bookName]\n      );\n    }\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEO,eAAe,IAAI,OAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,QAAQ,aAAa,GAAG,CAAC;IAC/B,MAAM,OAAO,OAAO,aAAa,GAAG,CAAC;IAErC,IAAI,CAAC,SAAS,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,MAAM,EAAE;IAAC;IAEzD,IAAI;QACF,MAAM,QAAQ,CAAC;;;;;;;;;;;;;IAaf,CAAC;QAED,MAAM,OAAO,MAAM,IAAA,2HAAY,EAAC,OAAO;YAAC;YAAO;SAAK;QAEpD,4EAA4E;QAC5E,MAAM,YAAY,KAAK,GAAG,CAAC,CAAC,IAAW,CAAC;gBACtC,GAAG,CAAC;gBACJ,QAAQ,OAAO,EAAE,MAAM,KAAK;gBAC5B,aAAa,OAAO,EAAE,WAAW,KAAK;gBACtC,OAAO,OAAO,EAAE,KAAK;YACvB,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM;QAAU;IAC7C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM,EAAE;QAAC;IACtC;AACF;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,UAAU,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG;QAC9F,MAAM,QAAQ,OAAO,eAAe;QAEpC,MAAM,UAAU,MAAM,IAAA,2HAAY,EAAC,CAAC,4CAA4C,CAAC,EAAE;YAAC;SAAM;QAC1F,IAAI,QAAQ,MAAM,KAAK,GAAG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB;QACrF,MAAM,SAAS,OAAO,CAAC,EAAE,CAAC,EAAE;QAE5B,IAAI,WAAW,iBAAiB;YAC9B,MAAM,IAAA,2HAAY,EAAC,CAAC;;;;;;;;;MASpB,CAAC,EAAE;gBAAC;gBAAQ;gBAAU;gBAAQ;gBAAU;gBAAO;gBAAO;gBAAQ;gBAAM;aAAM;YAE1E,MAAM,IAAA,2HAAY,EAChB,CAAC,mFAAmF,CAAC,EACrF;gBAAC;gBAAO;gBAAO;aAAS;QAE5B;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAY;QACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}